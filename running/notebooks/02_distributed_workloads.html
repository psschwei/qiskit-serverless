<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Parallel workflows in programs &#8212; Quantum serverless 0.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Programs with arguments and saved results" href="03_arguments_and_results.html" />
    <link rel="prev" title="Running a program remotely" href="01_running_program.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="Parallel-workflows-in-programs">
<h1>Parallel workflows in programs<a class="headerlink" href="#Parallel-workflows-in-programs" title="Permalink to this heading">¶</a></h1>
<p>In this document, we will learn how to run distributed workflows inside a program.</p>
<p>Let’s take a look at the program file <a class="reference external" href="./source_files/program_4.py">./source_files/program_4.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># source_files/program_4.py</span>

<span class="kn">from</span> <span class="nn">quantum_serverless</span> <span class="kn">import</span> <span class="n">get_arguments</span><span class="p">,</span> <span class="n">save_result</span><span class="p">,</span> <span class="n">distribute_task</span><span class="p">,</span> <span class="n">get</span>

<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span> <span class="nn">qiskit.primitives</span> <span class="kn">import</span> <span class="n">Sampler</span>


<span class="nd">@distribute_task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">distributed_sample</span><span class="p">(</span><span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Distributed task that returns quasi distribution for given circuit.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Sampler</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">arguments</span> <span class="o">=</span> <span class="n">get_arguments</span><span class="p">()</span>
<span class="n">circuits</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;circuits&quot;</span><span class="p">)</span>


<span class="c1"># run distributed tasks as async function</span>
<span class="c1"># we get task references as a return type</span>
<span class="n">sample_task_references</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">distributed_sample</span><span class="p">(</span><span class="n">circuit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">circuits</span>
<span class="p">]</span>

<span class="c1"># now we need to collect results from task references</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">sample_task_references</span><span class="p">)</span>

<span class="n">save_result</span><span class="p">({</span>
    <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span>
<span class="p">})</span>
</pre></div>
</div>
<p>There are a lot of new concepts introduced in this program, so let’s go over them in more detail:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">distribute_task</span></code> decorator converts a function into a distributed task. This means that the function will be executed on compute resources asynchronously and in parallel to the main context of the program.</p>
<p>When you call a converted function, it will return a reference to the function execution instead of the result. In order to get the result back, you need to call the get function on the function reference. get will wait until the function is finished and return the result of the function execution.</p>
<p>In the program above, we have applied the <code class="docutils literal notranslate"><span class="pre">distribute_task</span></code> decorator to the <code class="docutils literal notranslate"><span class="pre">distributed_sample</span></code> function. This function takes a <code class="docutils literal notranslate"><span class="pre">QuantumCircuit</span></code> as input and returns the quasi distribution for that circuit.</p>
<p>After we have defined the <code class="docutils literal notranslate"><span class="pre">distributed_sample</span></code> function, we read the circuits from the program arguments using the <code class="docutils literal notranslate"><span class="pre">get_arguments</span></code> function. We then call the distributed_sample function for each of the circuits, which creates a reference to each of the function executions.</p>
<p>These function executions will run in parallel on compute resources, and we get task references as the return type. We store these task references in the <code class="docutils literal notranslate"><span class="pre">sample_task_references</span></code> list.</p>
<p>After we have created the task references for each of the function executions, we need to collect the results from these tasks. We do this by calling the <code class="docutils literal notranslate"><span class="pre">get</span></code> function on the list of task references, which waits until all the tasks have completed and returns the results.</p>
<p>Once we have the results, we can save them using the <code class="docutils literal notranslate"><span class="pre">save_result</span></code> function.</p>
<p>Essentially, this program reads the circuits from the program arguments, executes the distributed_sample function on each circuit in parallel, collects the results from the function executions, and saves the results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">quantum_serverless</span> <span class="kn">import</span> <span class="n">QuantumServerless</span><span class="p">,</span> <span class="n">GatewayProvider</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">provider</span> <span class="o">=</span> <span class="n">GatewayProvider</span><span class="p">(</span>
    <span class="n">username</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="s2">&quot;password123&quot;</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GATEWAY_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">serverless</span> <span class="o">=</span> <span class="n">QuantumServerless</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span>
<span class="n">serverless</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;QuantumServerless | providers [gateway-provider]&gt;
</pre></div></div>
</div>
<p>Let’s create list of random circuit which we will be using as arguments</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit.circuit.random</span> <span class="kn">import</span> <span class="n">random_circuit</span>

<span class="n">circuits</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_circuit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="p">[</span><span class="n">circuit</span><span class="o">.</span><span class="n">measure_all</span><span class="p">()</span> <span class="k">for</span> <span class="n">circuit</span> <span class="ow">in</span> <span class="n">circuits</span><span class="p">]</span>
<span class="n">circuits</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;qiskit.circuit.quantumcircuit.QuantumCircuit at 0x7fbfa85664d0&gt;,
 &lt;qiskit.circuit.quantumcircuit.QuantumCircuit at 0x7fbf794c6450&gt;,
 &lt;qiskit.circuit.quantumcircuit.QuantumCircuit at 0x7fbfa9781390&gt;]
</pre></div></div>
</div>
<p>Run program as usual</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">quantum_serverless</span> <span class="kn">import</span> <span class="n">Program</span>

<span class="n">program</span> <span class="o">=</span> <span class="n">Program</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Program with distributed workflow&quot;</span><span class="p">,</span>
    <span class="n">entrypoint</span><span class="o">=</span><span class="s2">&quot;program_4.py&quot;</span><span class="p">,</span>
    <span class="n">working_dir</span><span class="o">=</span><span class="s2">&quot;./source_files/&quot;</span>
<span class="p">)</span>

<span class="n">job</span> <span class="o">=</span> <span class="n">serverless</span><span class="o">.</span><span class="n">run_program</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;circuits&quot;</span><span class="p">:</span> <span class="n">circuits</span><span class="p">})</span>
<span class="n">job</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Job | 1d472ab5-6cf6-47c4-8166-8162e043c4bd&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;SUCCEEDED&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;results&#39;: [{&#39;0&#39;: 0.25, &#39;1&#39;: 0.25, &#39;2&#39;: 0.25, &#39;3&#39;: 0.25},
  {&#39;0&#39;: 0.4931987115505575,
   &#39;1&#39;: 0.4931987115505575,
   &#39;2&#39;: 0.0068012884494424,
   &#39;3&#39;: 0.0068012884494424},
  {&#39;0&#39;: 1.0}]}
</pre></div></div>
</div>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Quantum serverless</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Qiskit-Extensions&repo=quantum-serverless&type=star&count=False&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Quickstart</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Running</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_running_program.html">Running a program remotely</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Parallel workflows in programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_arguments_and_results.html">Programs with arguments and saved results</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_dependencies.html">Dependency management for programs</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs/index.html">API References</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/Qiskit-Extensions/quantum-serverless">Repository</a></li>
    
    <li class="toctree-l1"><a href="https://github.com/Qiskit-Extensions/quantum-serverless/issues/new?assignees=&labels=bug&template=bug_report.md">Report issues</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Running</a><ul>
  <li><a href="index.html">&lt;no title&gt;</a><ul>
      <li>Previous: <a href="01_running_program.html" title="previous chapter">Running a program remotely</a></li>
      <li>Next: <a href="03_arguments_and_results.html" title="next chapter">Programs with arguments and saved results</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/running/notebooks/02_distributed_workloads.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>