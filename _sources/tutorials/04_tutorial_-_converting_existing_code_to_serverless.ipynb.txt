{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "19592fcb-7308-4c29-a973-5b226c2c3f4e",
   "metadata": {},
   "source": [
    "# Tutorial: converting existing code to serverless without internal code modifications"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "9242f125-579b-49d7-ae01-d3e9f9cb04e1",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import warnings\n",
    "\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "from quantum_serverless import QuantumServerless, run_qiskit_remote, get, put"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0b15cefd-f7b0-409e-af0f-5d8546887bd3",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "There are couple of ways to make your code running as serverless code:\n",
    "- wrapping entire functions / classes as actors or functions\n",
    "- monkey-patching existing class functions to swap some parts of code"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d996562c-553e-4ce2-a4ff-6709357b886e",
   "metadata": {},
   "source": [
    "### Approach #1: wrapping function / classes as tasks / actors\n",
    "\n",
    "We will work with qiskit and try to wrap some functions / classes as tasks / actors"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c6d593d0-435c-456a-a16e-9265c43f1d3c",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<pre style=\"word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace\">      ┌───┐ ┌───┐                                \n",
       "q_0: ─┤ X ├─┤ X ├──■─────────────────────────────\n",
       "     ┌┴───┴┐└─┬─┘  │  ┌─────────────────────────┐\n",
       "q_1: ┤ Sdg ├──■────┼──┤ U3(1.417,2.9487,2.2238) ├\n",
       "     └─────┘  │    │  └─────────────────────────┘\n",
       "q_2: ───■─────■────■─────────────────────────────\n",
       "        │        ┌─┴─┐                           \n",
       "q_3: ───■─────■──┤ X ├───────────────────────────\n",
       "      ┌─┴─┐ ┌─┴─┐├───┤                           \n",
       "q_4: ─┤ X ├─┤ Y ├┤ T ├───────────────────────────\n",
       "      └───┘ └───┘└───┘                           </pre>"
      ],
      "text/plain": [
       "      ┌───┐ ┌───┐                                \n",
       "q_0: ─┤ X ├─┤ X ├──■─────────────────────────────\n",
       "     ┌┴───┴┐└─┬─┘  │  ┌─────────────────────────┐\n",
       "q_1: ┤ Sdg ├──■────┼──┤ U3(1.417,2.9487,2.2238) ├\n",
       "     └─────┘  │    │  └─────────────────────────┘\n",
       "q_2: ───■─────■────■─────────────────────────────\n",
       "        │        ┌─┴─┐                           \n",
       "q_3: ───■─────■──┤ X ├───────────────────────────\n",
       "      ┌─┴─┐ ┌─┴─┐├───┤                           \n",
       "q_4: ─┤ X ├─┤ Y ├┤ T ├───────────────────────────\n",
       "      └───┘ └───┘└───┘                           "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from qiskit import QuantumCircuit, transpile\n",
    "from qiskit.providers import Backend\n",
    "from qiskit.circuit.random import random_circuit\n",
    "from qiskit.providers.aer import AerSimulator\n",
    "from qiskit.test.mock import FakeVigo, FakeAlmaden, FakeBrooklyn, FakeCasablanca\n",
    "\n",
    "circuit = random_circuit(5, 3)\n",
    "backend = AerSimulator.from_backend(FakeAlmaden())\n",
    "\n",
    "circuit.draw()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ffedccc0-ce50-4808-96ee-b5ce39222278",
   "metadata": {},
   "source": [
    "We have transpile function. Let's start with transpilation function.\n",
    "\n",
    "You can call `transpile(circuits, backend)` to compile circuits to specific backend locally. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "9887fd2e-0218-48db-9338-15c47da9dc04",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<pre style=\"word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace\">global phase: 0\n",
       "           ┌──────────┐                                                                                                                                            ┌─────────┐                                         ┌───┐┌──────────┐     ┌───┐┌─────────────────────────┐                                                                                                                       \n",
       " q_1 -> 9 ─┤ U1(-π/2) ├───────■─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ U1(π/4) ├─────────────────────────────────────────┤ X ├┤ U1(-π/4) ├─────┤ X ├┤ U3(1.417,2.9487,2.2238) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "           └──────────┘       │                                   ┌─────────┐                                       ┌───┐    ┌──────────┐┌───┐                  │  └─────────┘                                         └─┬─┘└──┬───┬───┘     └─┬─┘└─────────────────────────┘                                                  ┌─────────┐                     ┌───┐     ┌───┐                      \n",
       "q_3 -> 12 ───────────────■────┼────────────────────────────────■──┤ U1(π/4) ├───────────────────────────────────────┤ X ├────┤ U1(-π/4) ├┤ X ├──────────────────┼───────────────────────────────────────────────────■────┼─────┤ X ├──────■────┼───────────────────────────────────────────■────────────────────────────────■──┤ U1(π/4) ├─────────────────────┤ X ├──■──┤ X ├──────────────────────\n",
       "           ┌─────────┐ ┌─┴─┐  │  ┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐   └─┬─┘    ├─────────┬┘└─┬─┘                  │                                       ┌───┐     ┌─┴─┐  │     └─┬─┘    ┌─┴─┐  │                             ┌─────────┐ ┌─┴─┐┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐└─┬─┘┌─┴─┐└─┬─┘┌───┐┌──────────┐┌───┐\n",
       "q_4 -> 13 ─┤ U2(0,π) ├─┤ X ├──┼──┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├─────■──────┤ U1(π/4) ├───■────■───────────────┼────────────────■───────────────────■──┤ X ├──■──┤ X ├──┼───────■──────┤ X ├──┼───────────────■─────────────┤ U2(0,π) ├─┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├──■──┤ X ├──■──┤ X ├┤ U1(-π/4) ├┤ X ├\n",
       "          ┌┴─────────┴┐└───┘┌─┴─┐├──────────┤└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘            └─────────┘      ┌─┴─┐┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐└───┘  │  ┌─────────┐ └───┘  │               │             └─────────┘ └───┘└──────────┘└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘     └───┘     └─┬─┘├─────────┬┘└─┬─┘\n",
       "q_0 -> 14 ┤ U2(-π,-π) ├─────┤ X ├┤ U1(-π/4) ├──┼────────────────────────────────┼───────────────────┼────┼────┼───────────────────────────────┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├───────■──┤ U1(π/4) ├────────■───────────────┼────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■──\n",
       "          └───────────┘     └───┘└──────────┘  │                                │                   │  ┌─┴─┐  │  ┌──────────┐                 └───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘          └─────────┘                      ┌─┴─┐           ┌──────────┐                                                                                          └─────────┘      \n",
       "q_2 -> 18 ─────────────────────────────────────■────────────────────────────────■───────────────────■──┤ X ├──■──┤ U1(-π/2) ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ X ├───────────┤ U1(3π/4) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                                                                                                       └───┘     └──────────┘                                                                                                                                └───┘           └──────────┘                                                                                                           </pre>"
      ],
      "text/plain": [
       "global phase: 0\n",
       "           ┌──────────┐                                                                                                                                            ┌─────────┐                                         ┌───┐┌──────────┐     ┌───┐┌─────────────────────────┐                                                                                                                       \n",
       " q_1 -> 9 ─┤ U1(-π/2) ├───────■─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ U1(π/4) ├─────────────────────────────────────────┤ X ├┤ U1(-π/4) ├─────┤ X ├┤ U3(1.417,2.9487,2.2238) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "           └──────────┘       │                                   ┌─────────┐                                       ┌───┐    ┌──────────┐┌───┐                  │  └─────────┘                                         └─┬─┘└──┬───┬───┘     └─┬─┘└─────────────────────────┘                                                  ┌─────────┐                     ┌───┐     ┌───┐                      \n",
       "q_3 -> 12 ───────────────■────┼────────────────────────────────■──┤ U1(π/4) ├───────────────────────────────────────┤ X ├────┤ U1(-π/4) ├┤ X ├──────────────────┼───────────────────────────────────────────────────■────┼─────┤ X ├──────■────┼───────────────────────────────────────────■────────────────────────────────■──┤ U1(π/4) ├─────────────────────┤ X ├──■──┤ X ├──────────────────────\n",
       "           ┌─────────┐ ┌─┴─┐  │  ┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐   └─┬─┘    ├─────────┬┘└─┬─┘                  │                                       ┌───┐     ┌─┴─┐  │     └─┬─┘    ┌─┴─┐  │                             ┌─────────┐ ┌─┴─┐┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐└─┬─┘┌─┴─┐└─┬─┘┌───┐┌──────────┐┌───┐\n",
       "q_4 -> 13 ─┤ U2(0,π) ├─┤ X ├──┼──┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├─────■──────┤ U1(π/4) ├───■────■───────────────┼────────────────■───────────────────■──┤ X ├──■──┤ X ├──┼───────■──────┤ X ├──┼───────────────■─────────────┤ U2(0,π) ├─┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├──■──┤ X ├──■──┤ X ├┤ U1(-π/4) ├┤ X ├\n",
       "          ┌┴─────────┴┐└───┘┌─┴─┐├──────────┤└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘            └─────────┘      ┌─┴─┐┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐└───┘  │  ┌─────────┐ └───┘  │               │             └─────────┘ └───┘└──────────┘└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘     └───┘     └─┬─┘├─────────┬┘└─┬─┘\n",
       "q_0 -> 14 ┤ U2(-π,-π) ├─────┤ X ├┤ U1(-π/4) ├──┼────────────────────────────────┼───────────────────┼────┼────┼───────────────────────────────┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├───────■──┤ U1(π/4) ├────────■───────────────┼────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■──\n",
       "          └───────────┘     └───┘└──────────┘  │                                │                   │  ┌─┴─┐  │  ┌──────────┐                 └───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘          └─────────┘                      ┌─┴─┐           ┌──────────┐                                                                                          └─────────┘      \n",
       "q_2 -> 18 ─────────────────────────────────────■────────────────────────────────■───────────────────■──┤ X ├──■──┤ U1(-π/2) ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ X ├───────────┤ U1(3π/4) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                                                                                                       └───┘     └──────────┘                                                                                                                                └───┘           └──────────┘                                                                                                           "
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# let's transpile function to see what it does\n",
    "transpiled_circuit = transpile(circuit, backend)\n",
    "\n",
    "transpiled_circuit.draw(idle_wires=False, fold=-1)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0ab5ecfc-7f22-44f4-9e12-f1863d6e9a3a",
   "metadata": {},
   "source": [
    "We can turn this function in ray remote function, that can be executed in parallel on configured machine / cluster"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "df0cae01-c9c5-4782-9486-42cd71342554",
   "metadata": {},
   "outputs": [],
   "source": [
    "remote_transpile = run_qiskit_remote()(transpile)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "69a87950-a361-4dab-8ea0-315a3aa5dd58",
   "metadata": {},
   "source": [
    "Now we have remote transpile function, we can try it out. But before let's create serverless class which will gives us executon context."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "f846d2c7-23aa-4f70-b4fb-913ebf4d6de9",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<QuantumServerless | providers [local]>"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "serverless = QuantumServerless()\n",
    "serverless"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "c45818f2-6b8b-401b-ab2f-e1b72af275af",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Pointer to task: ObjectRef(c8ef45ccd0112571ffffffffffffffffffffffff0100000001000000)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<pre style=\"word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace\">global phase: 0\n",
       "           ┌──────────┐                                                                                                                                            ┌─────────┐                                         ┌───┐┌──────────┐     ┌───┐┌─────────────────────────┐                                                                                                                       \n",
       " q_1 -> 9 ─┤ U1(-π/2) ├───────■─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ U1(π/4) ├─────────────────────────────────────────┤ X ├┤ U1(-π/4) ├─────┤ X ├┤ U3(1.417,2.9487,2.2238) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "           └──────────┘       │                                   ┌─────────┐                                       ┌───┐    ┌──────────┐┌───┐                  │  └─────────┘                                    ┌───┐└─┬─┘└──────────┘┌───┐└─┬─┘└─────────────────────────┘                                                  ┌─────────┐                          ┌───┐                           \n",
       "q_3 -> 12 ───────────────■────┼────────────────────────────────■──┤ U1(π/4) ├───────────────────────────────────────┤ X ├────┤ U1(-π/4) ├┤ X ├──────────────────┼─────────────────────────────────────────────────┤ X ├──┼───────■──────┤ X ├──┼───────────────────────────────────────────■────────────────────────────────■──┤ U1(π/4) ├───────────────────────■──┤ X ├──■────────────────────────\n",
       "           ┌─────────┐ ┌─┴─┐  │  ┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐   └─┬─┘    ├─────────┬┘└─┬─┘                  │                                       ┌───┐     └─┬─┘  │     ┌─┴─┐    └─┬─┘  │                             ┌─────────┐ ┌─┴─┐┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐┌───┐┌──────────┐┌───┐\n",
       "q_4 -> 13 ─┤ U2(0,π) ├─┤ X ├──┼──┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├─────■──────┤ U1(π/4) ├───■────■───────────────┼────────────────■───────────────────■──┤ X ├──■────■────┼─────┤ X ├──────■────┼───────────────■─────────────┤ U2(0,π) ├─┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├┤ X ├┤ U1(-π/4) ├┤ X ├\n",
       "          ┌┴─────────┴┐└───┘┌─┴─┐├──────────┤└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘            └─────────┘      ┌─┴─┐┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐       │  ┌──┴───┴──┐        │               │             └─────────┘ └───┘└──────────┘└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└───┘     └───┘└─┬─┘├─────────┬┘└─┬─┘\n",
       "q_0 -> 14 ┤ U2(-π,-π) ├─────┤ X ├┤ U1(-π/4) ├──┼────────────────────────────────┼───────────────────┼────┼────┼───────────────────────────────┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├───────■──┤ U1(π/4) ├────────■───────────────┼────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■──\n",
       "          └───────────┘     └───┘└──────────┘  │                                │                   │  ┌─┴─┐  │  ┌──────────┐                 └───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘          └─────────┘                      ┌─┴─┐           ┌──────────┐                                                                                          └─────────┘      \n",
       "q_2 -> 18 ─────────────────────────────────────■────────────────────────────────■───────────────────■──┤ X ├──■──┤ U1(-π/2) ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ X ├───────────┤ U1(3π/4) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                                                                                                       └───┘     └──────────┘                                                                                                                                └───┘           └──────────┘                                                                                                           </pre>"
      ],
      "text/plain": [
       "global phase: 0\n",
       "           ┌──────────┐                                                                                                                                            ┌─────────┐                                         ┌───┐┌──────────┐     ┌───┐┌─────────────────────────┐                                                                                                                       \n",
       " q_1 -> 9 ─┤ U1(-π/2) ├───────■─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ U1(π/4) ├─────────────────────────────────────────┤ X ├┤ U1(-π/4) ├─────┤ X ├┤ U3(1.417,2.9487,2.2238) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "           └──────────┘       │                                   ┌─────────┐                                       ┌───┐    ┌──────────┐┌───┐                  │  └─────────┘                                    ┌───┐└─┬─┘└──────────┘┌───┐└─┬─┘└─────────────────────────┘                                                  ┌─────────┐                          ┌───┐                           \n",
       "q_3 -> 12 ───────────────■────┼────────────────────────────────■──┤ U1(π/4) ├───────────────────────────────────────┤ X ├────┤ U1(-π/4) ├┤ X ├──────────────────┼─────────────────────────────────────────────────┤ X ├──┼───────■──────┤ X ├──┼───────────────────────────────────────────■────────────────────────────────■──┤ U1(π/4) ├───────────────────────■──┤ X ├──■────────────────────────\n",
       "           ┌─────────┐ ┌─┴─┐  │  ┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐   └─┬─┘    ├─────────┬┘└─┬─┘                  │                                       ┌───┐     └─┬─┘  │     ┌─┴─┐    └─┬─┘  │                             ┌─────────┐ ┌─┴─┐┌──────────┐┌───┐┌─────────┐┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐┌───┐┌──────────┐┌───┐\n",
       "q_4 -> 13 ─┤ U2(0,π) ├─┤ X ├──┼──┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├─────■──────┤ U1(π/4) ├───■────■───────────────┼────────────────■───────────────────■──┤ X ├──■────■────┼─────┤ X ├──────■────┼───────────────■─────────────┤ U2(0,π) ├─┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├┤ X ├┤ U1(-π/4) ├┤ X ├\n",
       "          ┌┴─────────┴┐└───┘┌─┴─┐├──────────┤└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘            └─────────┘      ┌─┴─┐┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐       │  ┌──┴───┴──┐        │               │             └─────────┘ └───┘└──────────┘└─┬─┘└─────────┘└───┘└──────────┘└─┬─┘└─────────────┘└───┘     └───┘└─┬─┘├─────────┬┘└─┬─┘\n",
       "q_0 -> 14 ┤ U2(-π,-π) ├─────┤ X ├┤ U1(-π/4) ├──┼────────────────────────────────┼───────────────────┼────┼────┼───────────────────────────────┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├───────■──┤ U1(π/4) ├────────■───────────────┼────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■──\n",
       "          └───────────┘     └───┘└──────────┘  │                                │                   │  ┌─┴─┐  │  ┌──────────┐                 └───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘          └─────────┘                      ┌─┴─┐           ┌──────────┐                                                                                          └─────────┘      \n",
       "q_2 -> 18 ─────────────────────────────────────■────────────────────────────────■───────────────────■──┤ X ├──■──┤ U1(-π/2) ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤ X ├───────────┤ U1(3π/4) ├───────────────────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                                                                                                       └───┘     └──────────┘                                                                                                                                └───┘           └──────────┘                                                                                                           "
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "with serverless:\n",
    "    # execute remote transpile function and get back pointer to remote task, \n",
    "    #    so we can fetch results out of it\n",
    "    task = remote_transpile(circuit, backend)\n",
    "    print(f\"Pointer to task: {task}\")\n",
    "    \n",
    "    # get actual results from task, \n",
    "    #    which will be our transpiled circuit\n",
    "    remotely_transpiled_circuits = get(task)\n",
    "\n",
    "remotely_transpiled_circuits.draw(idle_wires=False, fold=-1)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "76457206-e976-4dc7-a834-60364494cb79",
   "metadata": {},
   "source": [
    "Because we have this function as ray remote function, we can run multiple of them in parallel"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "8295a707-0a1c-460c-afdb-c949062bbd98",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<pre style=\"word-wrap: normal;white-space: pre;background: #fff0;line-height: 1.1;font-family: &quot;Courier New&quot;,Courier,monospace\">global phase: 3.1306\n",
       "                               ┌───┐                 ┌───┐┌─────────────────────┐                                                                                                                                                                                                            ┌─────────┐                                                                                                   ┌───┐                    ┌───┐                                                                                     \n",
       " q_3 -> 9 ─────────────────────┤ X ├─────────■───────┤ X ├┤ U3(1.1556,π/2,-π/2) ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■───────────────────────────────────────────────────────────────────────────────────────────────┤ X ├────────────■───────┤ X ├─────────────────────────────────────────────────────────────────────────────────────\n",
       "                               └─┬─┘         │       └─┬─┘└─────────────────────┘     ┌─────────┐                                    ┌───┐┌──────────┐┌───┐┌───────────────────────────┐                              │                                │                                  │  └─────────┘   │                                                                                               └─┬─┘            │       └─┬─┘                                                                                     \n",
       "q_0 -> 12 ───────────────────────┼───────────┼─────────┼───────────────────────────■──┤ U1(π/4) ├────────────────────────────────────┤ X ├┤ U1(-π/4) ├┤ X ├┤ U3(2.2178,2.7588,0.70376) ├──────────────────────────────┼────────────────────────────────┼──────────────────────────────────┼────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────┼──────────────┼─────────┼───────────────────────────────────────────────────────────────────────────────────────\n",
       "          ┌─────────────┐        │           │  ┌───┐  │        ┌─────────┐      ┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐└─┬─┘├─────────┬┘└─┬─┘└───────────┬───┬───────────┘                              │                  ┌─────────┐   │                      ┌───┐       │                │       ┌────────────────────────┐┌───┐┌───────────────────────┐┌───┐  ┌──────────────────────┐   │  ┌───┐       │  ┌───┐  │  ┌───────────────────────┐                                       ┌───────────────┐    \n",
       "q_4 -> 13 ┤ U2(-π/4,-π) ├────────┼───────────┼──┤ X ├──┼────────┤ U1(π/4) ├──────┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,1.641) ├┤ X ├──■──┤ X ├──■──┤ U1(π/4) ├───■──────────────┤ X ├─────────────────────────■────────────────┼───────────────■──┤ U1(π/4) ├───┼───────────────────■──┤ X ├──■────┼────────────────┼────■──┤ U1(-0.944196508933282) ├┤ X ├┤ U3(1.0866,-π,0.12636) ├┤ X ├──┤ U3(1.0866,0.81784,0) ├───┼──┤ X ├──■────┼──┤ X ├──┼──┤ U1(0.627327644292588) ├───■────────────────────────────■──────┤ U3(π,π/2,π/2) ├────\n",
       "          └─────────────┘        │         ┌─┴─┐└─┬─┘  │        └┬───────┬┘      └───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘     └─────────┘                  └─┬─┘            ┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────┐┌─┴─┐├─────────┴┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐┌─┴─┐┌──────────┐┌─┴─┐┌─┴─┐└┬──────────────────────┬┘└─┬─┘└───────────────────────┘└─┬─┘┌─┴──────────────────────┴┐  │  └─┬─┘  │  ┌─┴─┐└─┬─┘  │  ├───────────────────────┴┐┌─┴─┐┌──────────────────────┐┌─┴─┐┌───┴───────────────┴───┐\n",
       "q_2 -> 14 ───────────────────────■─────────┤ X ├──┼────■─────────┤ U1(π) ├──────────────────────────┼───────────────────┼────┼────┼──────────────────────────────────────■──────────────┤ U2(0,π) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ X ├─┤ U1(3.01523521327176) ├───■─────────────────────────────■──┤ U3(2.724,0.99285,1.685) ├──■────┼────┼──┤ X ├──┼────■──┤ U1(-0.238171820801467) ├┤ X ├┤ U3(2.2928,-π,2.5143) ├┤ X ├┤ U3(2.2928,0.080101,0) ├\n",
       "                         ┌────────────────┐└───┘  │              └───────┘                          │                   │  ┌─┴─┐  │                                                     └─────────┘└───┘└──────────┘└───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘└───┘└──────────┘└───┘└───┘ └──────────────────────┘                                    └─────────────────────────┘       │  ┌─┴─┐└───┘  │       └────────────────────────┘└───┘└──────────────────────┘└───┘└───────────────────────┘\n",
       "q_1 -> 18 ───────────────┤ U3(0.3885,0,0) ├───────■─────────────────────────────────────────────────■───────────────────■──┤ X ├──■───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ X ├───────■────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                         └────────────────┘                                                                                └───┘                                                                                                                                                                                                                                                                                     └───┘                                                                                                    </pre>"
      ],
      "text/plain": [
       "global phase: 3.1306\n",
       "                               ┌───┐                 ┌───┐┌─────────────────────┐                                                                                                                                                                                                            ┌─────────┐                                                                                                   ┌───┐                    ┌───┐                                                                                     \n",
       " q_3 -> 9 ─────────────────────┤ X ├─────────■───────┤ X ├┤ U3(1.1556,π/2,-π/2) ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■────────────────────────────────■──────────────────────────────────■──┤ U1(π/4) ├───■───────────────────────────────────────────────────────────────────────────────────────────────┤ X ├────────────■───────┤ X ├─────────────────────────────────────────────────────────────────────────────────────\n",
       "                               └─┬─┘         │       └─┬─┘└─────────────────────┘     ┌─────────┐                                    ┌───┐┌──────────┐┌───┐┌───────────────────────────┐                              │                                │                                  │  └─────────┘   │                                                                                               └─┬─┘            │       └─┬─┘                                                                                     \n",
       "q_0 -> 12 ───────────────────────┼───────────┼─────────┼───────────────────────────■──┤ U1(π/4) ├────────────────────────────────────┤ X ├┤ U1(-π/4) ├┤ X ├┤ U3(2.2178,2.7588,0.70376) ├──────────────────────────────┼────────────────────────────────┼──────────────────────────────────┼────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────┼──────────────┼─────────┼───────────────────────────────────────────────────────────────────────────────────────\n",
       "          ┌─────────────┐        │           │  ┌───┐  │        ┌─────────┐      ┌─┴─┐├─────────┴┐┌───┐┌─────────────┐┌───┐     ┌───┐└─┬─┘├─────────┬┘└─┬─┘└───────────┬───┬───────────┘                              │                  ┌─────────┐   │                      ┌───┐       │                │       ┌────────────────────────┐┌───┐┌───────────────────────┐┌───┐  ┌──────────────────────┐   │  ┌───┐       │  ┌───┐  │  ┌───────────────────────┐                                       ┌───────────────┐    \n",
       "q_4 -> 13 ┤ U2(-π/4,-π) ├────────┼───────────┼──┤ X ├──┼────────┤ U1(π/4) ├──────┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,1.641) ├┤ X ├──■──┤ X ├──■──┤ U1(π/4) ├───■──────────────┤ X ├─────────────────────────■────────────────┼───────────────■──┤ U1(π/4) ├───┼───────────────────■──┤ X ├──■────┼────────────────┼────■──┤ U1(-0.944196508933282) ├┤ X ├┤ U3(1.0866,-π,0.12636) ├┤ X ├──┤ U3(1.0866,0.81784,0) ├───┼──┤ X ├──■────┼──┤ X ├──┼──┤ U1(0.627327644292588) ├───■────────────────────────────■──────┤ U3(π,π/2,π/2) ├────\n",
       "          └─────────────┘        │         ┌─┴─┐└─┬─┘  │        └┬───────┬┘      └───┘└──────────┘└─┬─┘└─────────────┘└─┬─┘  │  └─┬─┘     └─────────┘                  └─┬─┘            ┌─────────┐┌─┴─┐┌──────────┐┌─┴─┐┌─────────┐┌─┴─┐├─────────┴┐┌─┴─┐┌─────────────┐┌─┴─┐└─┬─┘┌─┴─┐┌─┴─┐┌──────────┐┌─┴─┐┌─┴─┐└┬──────────────────────┬┘└─┬─┘└───────────────────────┘└─┬─┘┌─┴──────────────────────┴┐  │  └─┬─┘  │  ┌─┴─┐└─┬─┘  │  ├───────────────────────┴┐┌─┴─┐┌──────────────────────┐┌─┴─┐┌───┴───────────────┴───┐\n",
       "q_2 -> 14 ───────────────────────■─────────┤ X ├──┼────■─────────┤ U1(π) ├──────────────────────────┼───────────────────┼────┼────┼──────────────────────────────────────■──────────────┤ U2(0,π) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U1(π/4) ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ U2(0,-3π/4) ├┤ X ├──■──┤ X ├┤ X ├┤ U1(-π/4) ├┤ X ├┤ X ├─┤ U1(3.01523521327176) ├───■─────────────────────────────■──┤ U3(2.724,0.99285,1.685) ├──■────┼────┼──┤ X ├──┼────■──┤ U1(-0.238171820801467) ├┤ X ├┤ U3(2.2928,-π,2.5143) ├┤ X ├┤ U3(2.2928,0.080101,0) ├\n",
       "                         ┌────────────────┐└───┘  │              └───────┘                          │                   │  ┌─┴─┐  │                                                     └─────────┘└───┘└──────────┘└───┘└─────────┘└───┘└──────────┘└───┘└─────────────┘└───┘     └───┘└───┘└──────────┘└───┘└───┘ └──────────────────────┘                                    └─────────────────────────┘       │  ┌─┴─┐└───┘  │       └────────────────────────┘└───┘└──────────────────────┘└───┘└───────────────────────┘\n",
       "q_1 -> 18 ───────────────┤ U3(0.3885,0,0) ├───────■─────────────────────────────────────────────────■───────────────────■──┤ X ├──■───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────■──┤ X ├───────■────────────────────────────────────────────────────────────────────────────────────────────\n",
       "                         └────────────────┘                                                                                └───┘                                                                                                                                                                                                                                                                                     └───┘                                                                                                    "
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "with serverless:\n",
    "    # let's run 5 circuits transpilations in parallel\n",
    "    tasks = [\n",
    "        remote_transpile(random_circuit(5, i + 1), backend)\n",
    "        for i in range(5)\n",
    "    ]\n",
    "\n",
    "    # get all results when ready\n",
    "    transpiled_circuits = get(tasks)\n",
    "    \n",
    "# look at our final transpiled circuit\n",
    "transpiled_circuits[-1].draw(idle_wires=False, fold=-1)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d2541d01-7dc7-4f81-9406-e5217dd94c6a",
   "metadata": {},
   "source": [
    "### Approach #2: Monkey-patching\n",
    "\n",
    "Python is allowing you to change definitions of classes and function in a runtime.\n",
    "This is useful if you need to patch a small chunk of class with your implementation.\n",
    "In our case we will want to swap chunks of code that can be run in parallel with our ray calls."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bc2cbf84-64b3-4788-95f2-a3cbbc954dd4",
   "metadata": {},
   "source": [
    "Let's create a dummy class that we will be monkey-patching later"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "fc2ff5fc-b0d7-4e37-98ac-9d1ef40e214e",
   "metadata": {},
   "outputs": [],
   "source": [
    "class DummyClass:\n",
    "    def sum_n_times(self, a: int, b: int, n_times: int):\n",
    "        \"\"\"Do something n times.\"\"\"\n",
    "        \n",
    "        result = []\n",
    "        for i in range(n_times):\n",
    "            result.append(a + b)\n",
    "        return result     "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "dc9db34a-44f7-4a63-81f4-8e3e41306775",
   "metadata": {},
   "source": [
    "---\n",
    "Let's write patch function"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "a0ab28d9-9643-42ac-8c48-fede8e2ea35b",
   "metadata": {},
   "outputs": [],
   "source": [
    "@run_qiskit_remote()\n",
    "def sum_remote(a: int, b: int):\n",
    "    return a + b\n",
    "\n",
    "def sum_n_times_patch(self, a: int, b: int, n_times: int):\n",
    "    return get([\n",
    "        sum_remote(a, b)\n",
    "        for _ in range(n_times)\n",
    "    ])  "
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0d7a3244-6280-4f41-9f42-b13798b191fc",
   "metadata": {},
   "source": [
    "Patch it now"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "da462ace-3e52-460e-827a-4604f747cfd0",
   "metadata": {},
   "outputs": [],
   "source": [
    "DummyClass.sum_n_times = sum_n_times_patch"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2c8a1c83-f6b9-488d-adaa-8890ec450c71",
   "metadata": {},
   "source": [
    "Now we need to create instance of our patched class and run it"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "038f6a93-034c-46e2-b432-06b464391b77",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[2, 2, 2, 2, 2, 2, 2, 2, 2, 2]\n"
     ]
    }
   ],
   "source": [
    "dummy_class = DummyClass()\n",
    "\n",
    "with serverless:\n",
    "    result = dummy_class.sum_n_times(1, 1, n_times=10)\n",
    "    print(result)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5a880c08-aa14-4a57-8ec6-03976ba18c78",
   "metadata": {},
   "source": [
    "Function is leveraging parallelization internally now"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
